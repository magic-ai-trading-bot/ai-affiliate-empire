# First Deployment Guide

Step-by-step guide for deploying AI Affiliate Empire to staging and production for the first time.

## Overview

This guide walks through the complete deployment process from initial setup to production launch. Follow each step carefully to ensure a smooth deployment.

## Prerequisites Verification

Before starting deployment, verify all prerequisites are met:

```bash
# Check Node.js version
node --version
# Expected: v18.x or v20.x

# Check npm
npm --version

# Check Docker
docker --version

# Check Fly.io CLI
flyctl version

# Check GitHub CLI
gh --version

# Verify authentication
gh auth status
flyctl auth whoami
```

## Phase 1: Initial Setup (30 minutes)

### Step 1.1: Configure GitHub Secrets

```bash
# Run interactive setup script
cd /path/to/ai-affiliate-empire
./scripts/setup-github-secrets.sh

# Verify secrets are set
gh secret list
```

**Required secrets**:
- ✅ FLY_API_TOKEN
- ✅ GITHUB_TOKEN (auto-provided)

**Optional but recommended**:
- ⚠️ CODECOV_TOKEN
- ⚠️ SLACK_WEBHOOK_URL or DISCORD_WEBHOOK_URL

**Verification**:
```bash
# Should show at minimum:
# FLY_API_TOKEN          Updated YYYY-MM-DD
# GITHUB_TOKEN           Updated YYYY-MM-DD (auto)

gh secret list
```

### Step 1.2: Create Fly.io Applications

```bash
# Staging application
flyctl apps create ai-affiliate-empire-staging --org personal

# Production application
flyctl apps create ai-affiliate-empire --org personal

# Verify apps created
flyctl apps list
```

**Expected output**:
```
NAME                            OWNER       STATUS  PLATFORM  LATEST DEPLOY
ai-affiliate-empire            personal    pending  machines  -
ai-affiliate-empire-staging    personal    pending  machines  -
```

### Step 1.3: Provision Databases

```bash
# Staging database
flyctl postgres create \
  --name ai-affiliate-empire-staging-db \
  --org personal \
  --region iad \
  --vm-size shared-cpu-1x \
  --volume-size 10

# Production database
flyctl postgres create \
  --name ai-affiliate-empire-db \
  --org personal \
  --region iad \
  --vm-size shared-cpu-2x \
  --volume-size 20

# Verify databases
flyctl postgres list
```

**Save database credentials** (shown once during creation):
```
Username: postgres
Password: <auto-generated>
Connection string: postgresql://postgres:<password>@<hostname>:5432/ai_affiliate_empire
```

### Step 1.4: Attach Databases to Apps

```bash
# Attach staging database
flyctl postgres attach ai-affiliate-empire-staging-db \
  --app ai-affiliate-empire-staging

# Attach production database
flyctl postgres attach ai-affiliate-empire-db \
  --app ai-affiliate-empire

# Verify attachment
flyctl config show --app ai-affiliate-empire-staging | grep DATABASE_URL
flyctl config show --app ai-affiliate-empire | grep DATABASE_URL
```

### Step 1.5: Configure Fly.io Secrets

#### Staging Secrets

```bash
# Core configuration
flyctl secrets set \
  NODE_ENV="staging" \
  PORT="3000" \
  --app ai-affiliate-empire-staging

# AI Service API Keys
flyctl secrets set \
  OPENAI_API_KEY="sk-..." \
  ANTHROPIC_API_KEY="sk-ant-..." \
  --app ai-affiliate-empire-staging

# Set to true when ready to test, false for initial deployment
flyctl secrets set \
  ELEVENLABS_API_KEY="mock" \
  PIKA_LABS_API_KEY="mock" \
  --app ai-affiliate-empire-staging

# Platform credentials (mock for staging)
flyctl secrets set \
  YOUTUBE_CLIENT_ID="mock-staging" \
  YOUTUBE_CLIENT_SECRET="mock-staging" \
  TIKTOK_CLIENT_KEY="mock-staging" \
  INSTAGRAM_CLIENT_ID="mock-staging" \
  --app ai-affiliate-empire-staging

# Monitoring
flyctl secrets set \
  SENTRY_DSN="https://your-sentry-dsn" \
  SENTRY_ENVIRONMENT="staging" \
  --app ai-affiliate-empire-staging
```

#### Production Secrets

```bash
# Core configuration
flyctl secrets set \
  NODE_ENV="production" \
  PORT="3000" \
  --app ai-affiliate-empire

# AI Service API Keys
flyctl secrets set \
  OPENAI_API_KEY="sk-..." \
  ANTHROPIC_API_KEY="sk-ant-..." \
  ELEVENLABS_API_KEY="..." \
  PIKA_LABS_API_KEY="..." \
  --app ai-affiliate-empire

# AWS Secrets Manager (for production)
flyctl secrets set \
  AWS_SECRETS_MANAGER_ENABLED="true" \
  AWS_REGION="us-east-1" \
  AWS_ACCESS_KEY_ID="..." \
  AWS_SECRET_ACCESS_KEY="..." \
  SECRET_NAME_PREFIX="ai-affiliate-empire" \
  --app ai-affiliate-empire

# Real Platform credentials
flyctl secrets set \
  YOUTUBE_CLIENT_ID="..." \
  YOUTUBE_CLIENT_SECRET="..." \
  TIKTOK_CLIENT_KEY="..." \
  INSTAGRAM_CLIENT_ID="..." \
  --app ai-affiliate-empire

# Monitoring
flyctl secrets set \
  SENTRY_DSN="https://your-sentry-dsn" \
  SENTRY_ENVIRONMENT="production" \
  --app ai-affiliate-empire
```

**Verify secrets**:
```bash
flyctl secrets list --app ai-affiliate-empire-staging
flyctl secrets list --app ai-affiliate-empire
```

### Step 1.6: Configure Branch Protection

```bash
# Create and run branch protection setup script
./scripts/setup-branch-protection.sh

# Or manually via GitHub UI:
# Settings → Branches → Add rule for "main"
```

**Required settings**:
- Require pull request before merging
- Require status checks: lint, type-check, test, build
- Require linear history
- Dismiss stale reviews

**Verification**:
```bash
gh api /repos/:owner/:repo/branches/main/protection | jq '.required_status_checks.contexts'
```

## Phase 2: Staging Deployment (20 minutes)

### Step 2.1: Prepare Deployment Configuration

Verify Fly.io configuration files exist:

```bash
# Check staging config
cat deploy/fly.staging.toml

# Check production config
cat deploy/fly.production.toml
```

**Key settings in fly.staging.toml**:
```toml
app = "ai-affiliate-empire-staging"

[build]
  dockerfile = "Dockerfile"

[env]
  NODE_ENV = "staging"
  PORT = "3000"

[http_service]
  internal_port = 3000
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 0

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512
```

### Step 2.2: Run Pre-Deployment Checks

```bash
# Run full test suite
npm run test:all

# Run linting
npm run lint

# Run type checking
npx tsc --noEmit

# Build application
npm run build

# All checks should pass before deployment
```

### Step 2.3: Deploy to Staging (Automatic)

```bash
# Push to main branch (triggers automatic staging deployment)
git checkout main
git pull origin main
git push origin main

# Monitor deployment
gh run watch

# Or trigger manually
gh workflow run cd.yml -f environment=staging
```

**Monitor deployment**:
```bash
# Watch GitHub Actions
gh run watch

# Watch Fly.io logs in separate terminal
flyctl logs --app ai-affiliate-empire-staging
```

**Expected deployment steps**:
1. ✅ Checkout code
2. ✅ Setup Node.js
3. ✅ Install dependencies
4. ✅ Generate Prisma client
5. ✅ Build application
6. ✅ Setup Fly CLI
7. ✅ Deploy to Fly.io
8. ✅ Run smoke tests
9. ✅ Health check

### Step 2.4: Verify Staging Deployment

```bash
# Health check
curl https://ai-affiliate-empire-staging.fly.dev/health
# Expected: {"status":"ok","timestamp":"...","uptime":...}

# API documentation
curl https://ai-affiliate-empire-staging.fly.dev/api
# Expected: Swagger UI HTML

# Run smoke tests
npm run test:smoke:staging

# Check application logs
flyctl logs --app ai-affiliate-empire-staging

# Check application status
flyctl status --app ai-affiliate-empire-staging
```

### Step 2.5: Test Core Functionality

**Manual testing checklist**:

1. **Health Endpoint**:
   ```bash
   curl -v https://ai-affiliate-empire-staging.fly.dev/health
   # Expected: 200 OK
   ```

2. **API Documentation**:
   - Visit: https://ai-affiliate-empire-staging.fly.dev/api
   - Verify Swagger UI loads
   - Test sample endpoints

3. **Database Connectivity**:
   ```bash
   # SSH into application
   flyctl ssh console --app ai-affiliate-empire-staging

   # Inside container, test database
   node -e "console.log(process.env.DATABASE_URL)"
   ```

4. **Authentication** (if implemented):
   - Test login endpoint
   - Verify JWT tokens work
   - Test protected routes

5. **Content Generation** (mock mode):
   - Test product discovery endpoint
   - Verify AI integration works (mock)
   - Check content creation flow

### Step 2.6: Staging Sign-Off

Before proceeding to production, ensure:

- [ ] All smoke tests pass
- [ ] Health checks return 200 OK
- [ ] No errors in application logs
- [ ] Database migrations applied successfully
- [ ] API documentation accessible
- [ ] Core features functional (even in mock mode)
- [ ] Response times acceptable (<1s for API calls)
- [ ] No security warnings

## Phase 3: Production Deployment (30 minutes)

### Step 3.1: Pre-Production Checklist

Complete the [Deployment Checklist](./DEPLOYMENT_CHECKLIST.md):

```bash
# Review checklist
cat docs/deployment/DEPLOYMENT_CHECKLIST.md

# Verify all items checked:
✅ All tests passing
✅ GitHub secrets configured
✅ Fly.io apps and databases created
✅ Production secrets set
✅ Branch protection enabled
✅ Staging deployment successful
✅ Team notified of production deployment
```

### Step 3.2: Create Production Backup

```bash
# Create initial backup (for rollback safety)
flyctl postgres backup create --app ai-affiliate-empire-db

# Verify backup exists
flyctl postgres backup list --app ai-affiliate-empire-db
```

### Step 3.3: Deploy to Production (Manual)

Production deployments require manual approval:

```bash
# Trigger production deployment via GitHub Actions
gh workflow run cd.yml -f environment=production

# This will:
# 1. Deploy to staging first
# 2. Wait for manual approval
# 3. Deploy to production after approval
```

**Approval process**:
1. GitHub Actions will pause after staging deployment
2. Navigate to: https://github.com/:owner/:repo/actions
3. Click on the running workflow
4. Click "Review deployments"
5. Select "production" environment
6. Click "Approve and deploy"

**Monitor production deployment**:
```bash
# Watch GitHub Actions
gh run watch

# Watch production logs
flyctl logs --app ai-affiliate-empire

# Monitor errors in Sentry (if configured)
# Visit: https://sentry.io/organizations/your-org/projects/ai-affiliate-empire/
```

### Step 3.4: Verify Production Deployment

```bash
# Health check
curl https://ai-affiliate-empire.fly.dev/health

# Run production smoke tests
npm run test:smoke:production

# Check application status
flyctl status --app ai-affiliate-empire

# Verify database migrations
flyctl ssh console --app ai-affiliate-empire -C "npx prisma migrate status"
```

### Step 3.5: Post-Deployment Monitoring

Monitor for 15-30 minutes after deployment:

```bash
# Watch logs continuously
flyctl logs --app ai-affiliate-empire --follow

# Check metrics
flyctl metrics --app ai-affiliate-empire

# Monitor error rates
# Visit Sentry dashboard
# Visit Fly.io dashboard: https://fly.io/apps/ai-affiliate-empire
```

**What to monitor**:
- ✅ Error rates (should be low/zero)
- ✅ Response times (should be <1s)
- ✅ Memory usage (should be stable)
- ✅ CPU usage (should be <80%)
- ✅ Database connections (should be stable)

### Step 3.6: Production Sign-Off

Deployment is successful when:

- [ ] Health checks passing consistently
- [ ] No errors in application logs
- [ ] All smoke tests pass
- [ ] Response times within SLA
- [ ] Memory/CPU usage stable
- [ ] Database connections stable
- [ ] No customer complaints
- [ ] Monitoring dashboards green

## Phase 4: Post-Deployment (24 hours)

### Step 4.1: Configure Monitoring Alerts

```bash
# Fly.io health check alerts
flyctl scale count 1 --app ai-affiliate-empire

# Configure Sentry alerts
# 1. Visit Sentry project settings
# 2. Configure alert rules:
#    - Error rate > 10/minute
#    - Response time > 2s
#    - Failed deployments

# Configure Slack/Discord notifications
# Already configured via GitHub secrets
```

### Step 4.2: Document Deployment

Create deployment record:

```bash
# Update deployment log
cat >> deployments.log <<EOF
$(date -u +"%Y-%m-%dT%H:%M:%SZ"),$(git rev-parse HEAD),production,success,v1.0.0
EOF

# Commit deployment log
git add deployments.log
git commit -m "chore: record production deployment v1.0.0"
git push origin main
```

### Step 4.3: Communicate Success

Send deployment notification:

```bash
# Discord notification (if configured)
./.claude/send-discord.sh "🚀 Production deployment successful! Version 1.0.0 is now live at https://ai-affiliate-empire.fly.dev"

# Or manually notify team via:
# - Slack
# - Email
# - Team chat
```

### Step 4.4: Monitor for 24 Hours

**Monitoring checklist** (check every 4-6 hours):

```bash
# Check application health
curl https://ai-affiliate-empire.fly.dev/health

# Check error rates in Sentry
# Visit: https://sentry.io/...

# Check application logs
flyctl logs --app ai-affiliate-empire --lines 100

# Check metrics
flyctl metrics --app ai-affiliate-empire

# Check database health
flyctl postgres status --app ai-affiliate-empire-db
```

**Red flags** (require immediate attention):
- ⚠️ Error rate > 5%
- ⚠️ Response time > 2s average
- ⚠️ Memory usage > 90%
- ⚠️ Database connection errors
- ⚠️ Health check failures

## Troubleshooting Common Issues

### Issue: Deployment Fails with "Error building image"

**Symptoms**: Docker build fails during GitHub Actions

**Solutions**:
```bash
# Test build locally
docker build -t ai-affiliate-empire:test .

# Check Dockerfile syntax
docker build --dry-run .

# Review build logs
gh run view <run-id> --log
```

### Issue: Health Check Fails After Deployment

**Symptoms**: `/health` endpoint returns 500 or times out

**Diagnosis**:
```bash
# Check application logs
flyctl logs --app ai-affiliate-empire

# SSH into container
flyctl ssh console --app ai-affiliate-empire

# Check environment variables
flyctl ssh console --app ai-affiliate-empire -C "env | sort"

# Test database connection
flyctl ssh console --app ai-affiliate-empire -C "psql \$DATABASE_URL -c 'SELECT 1'"
```

**Solutions**:
1. Verify DATABASE_URL is set correctly
2. Check all required secrets are configured
3. Verify Prisma client is generated
4. Restart application: `flyctl apps restart ai-affiliate-empire`

### Issue: Database Migration Fails

**Symptoms**: Application won't start, migration errors in logs

**Diagnosis**:
```bash
# Check migration status
flyctl ssh console --app ai-affiliate-empire -C "npx prisma migrate status"

# Check database connection
flyctl postgres connect --app ai-affiliate-empire-db
```

**Solutions**:
```bash
# Option 1: Mark migration as applied (if already applied)
flyctl ssh console --app ai-affiliate-empire -C "npx prisma migrate resolve --applied <migration-name>"

# Option 2: Rollback migration
flyctl ssh console --app ai-affiliate-empire -C "npx prisma migrate resolve --rolled-back <migration-name>"

# Option 3: Force reset database (DESTRUCTIVE - staging only)
flyctl ssh console --app ai-affiliate-empire-staging -C "npx prisma migrate reset --force"
```

### Issue: Application Out of Memory

**Symptoms**: Application crashes, "Out of memory" errors

**Solutions**:
```bash
# Increase memory allocation
# Edit deploy/fly.production.toml
[[vm]]
  memory_mb = 2048  # Increase from 1024

# Redeploy
git add deploy/fly.production.toml
git commit -m "fix: increase memory allocation"
git push origin main
```

### Issue: Slow Response Times

**Symptoms**: API responses take > 2s

**Diagnosis**:
```bash
# Check metrics
flyctl metrics --app ai-affiliate-empire

# Check logs for slow queries
flyctl logs --app ai-affiliate-empire | grep "slow query"
```

**Solutions**:
1. Add database indexes
2. Implement caching (Redis)
3. Optimize queries
4. Scale resources

## Rollback Procedures

If critical issues arise, rollback immediately.

### Automated Rollback

```bash
# Run rollback script
./scripts/rollback.sh production

# Verify rollback
curl https://ai-affiliate-empire.fly.dev/health
npm run test:smoke:production
```

### Manual Rollback

```bash
# List recent releases
flyctl releases --app ai-affiliate-empire

# Rollback to previous release
flyctl releases rollback <release-number> --app ai-affiliate-empire

# Verify rollback
flyctl status --app ai-affiliate-empire
curl https://ai-affiliate-empire.fly.dev/health
```

### Database Rollback

```bash
# Restore from backup
flyctl postgres backup restore <backup-id> --app ai-affiliate-empire-db

# Verify restore
flyctl ssh console --app ai-affiliate-empire -C "psql \$DATABASE_URL -c 'SELECT COUNT(*) FROM \"Product\"'"
```

## Success Metrics

Track these metrics for deployment success:

| Metric | Target | Actual |
|--------|--------|--------|
| Deployment duration | <10 min | ___ min |
| Downtime | 0 min | ___ min |
| Time to first health check | <2 min | ___ min |
| Smoke test pass rate | 100% | ___% |
| Error rate (24h) | <1% | ___% |
| Average response time | <500ms | ___ ms |
| Rollback required | No | Yes/No |

## Next Deployments

For subsequent deployments:

1. **Hotfixes**: Follow [hotfix workflow](../deployment-guide.md#hotfix-deployment)
2. **Regular releases**: Use standard CI/CD pipeline
3. **Feature releases**: Deploy to staging → verify → deploy to production

**Best practices**:
- Deploy during low-traffic periods
- Always deploy to staging first
- Monitor for 24 hours after production deployment
- Keep rollback plan ready
- Communicate with team before production deployment

## Additional Resources

- [Deployment Guide](../deployment-guide.md)
- [Deployment Checklist](./DEPLOYMENT_CHECKLIST.md)
- [GitHub Secrets Setup](./GITHUB_SECRETS_SETUP.md)
- [CI/CD Testing](./CI_CD_TESTING.md)
- [Branch Protection Rules](./BRANCH_PROTECTION_RULES.md)
- [Fly.io Documentation](https://fly.io/docs/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

## Support

If you encounter issues not covered in this guide:

1. Check application logs: `flyctl logs --app ai-affiliate-empire`
2. Review GitHub Actions logs: `gh run view <run-id> --log`
3. Consult Fly.io community: https://community.fly.io
4. Create GitHub issue with deployment logs

---

**Congratulations!** 🎉 You've successfully deployed AI Affiliate Empire to production!
